#!/bin/sh
set -ex
ROOTDIR=$(cd $(dirname $0)/../ && pwd -P)

rm -rf MK_DIST

if [ ! -x ./script/build/unix/install ]; then
  git submodule update --init
fi

CURL_VERSION=7.61.1-9
GEOIP_VERSION=1.6.12-9
LIBEVENT_VERSION=2.1.8-9
LIBMAXMINDDB_VERSION=1.3.2-9
LIBRESSL_VERSION=2.7.4-9
MK_VERSION=0.9.0-alpha.11-9

# install dependencies

./script/build/unix/install ios-curl-$CURL_VERSION
./script/build/unix/install ios-geoip-api-c-$GEOIP_VERSION
./script/build/unix/install ios-libevent-$LIBEVENT_VERSION
./script/build/unix/install ios-libmaxminddb-$LIBMAXMINDDB_VERSION
./script/build/unix/install ios-libressl-$LIBRESSL_VERSION
./script/build/unix/install ios-measurement-kit-$MK_VERSION

# libcurl
rm -rf Frameworks/libcurl.framework
install -d Frameworks/libcurl.framework/Headers
/usr/bin/lipo -create -output Frameworks/libcurl.framework/libcurl             \
  MK_DIST/ios/curl/$CURL_VERSION/arm64/lib/libcurl.a                           \
  MK_DIST/ios/curl/$CURL_VERSION/armv7s/lib/libcurl.a                          \
  MK_DIST/ios/curl/$CURL_VERSION/x86_64/lib/libcurl.a
touch Frameworks/libcurl.framework/Headers/make_cocoapods_happy.h

# libGeoIP
rm -rf Frameworks/libGeoIP.framework
install -d Frameworks/libGeoIP.framework/Headers
/usr/bin/lipo -create -output Frameworks/libGeoIP.framework/libGeoIP           \
  MK_DIST/ios/geoip-api-c/$GEOIP_VERSION/arm64/lib/libGeoIP.a                  \
  MK_DIST/ios/geoip-api-c/$GEOIP_VERSION/armv7s/lib/libGeoIP.a                 \
  MK_DIST/ios/geoip-api-c/$GEOIP_VERSION/x86_64/lib/libGeoIP.a
touch Frameworks/libGeoIP.framework/Headers/make_cocoapods_happy.h

# libmaxminddb
rm -rf Frameworks/libmaxminddb.framework
install -d Frameworks/libmaxminddb.framework/Headers
/usr/bin/lipo -create -output Frameworks/libmaxminddb.framework/libmaxminddb   \
  MK_DIST/ios/libmaxminddb/$LIBMAXMINDDB_VERSION/arm64/lib/libmaxminddb.a      \
  MK_DIST/ios/libmaxminddb/$LIBMAXMINDDB_VERSION/armv7s/lib/libmaxminddb.a     \
  MK_DIST/ios/libmaxminddb/$LIBMAXMINDDB_VERSION/x86_64/lib/libmaxminddb.a
touch Frameworks/libmaxminddb.framework/Headers/make_cocoapods_happy.h

# libcrypto
rm -rf Frameworks/libcrypto.framework
install -d Frameworks/libcrypto.framework/Headers
/usr/bin/lipo -create -output Frameworks/libcrypto.framework/libcrypto         \
  MK_DIST/ios/libressl/$LIBRESSL_VERSION/arm64/lib/libcrypto.a                 \
  MK_DIST/ios/libressl/$LIBRESSL_VERSION/armv7s/lib/libcrypto.a                \
  MK_DIST/ios/libressl/$LIBRESSL_VERSION/x86_64/lib/libcrypto.a
touch Frameworks/libcrypto.framework/Headers/make_cocoapods_happy.h

# libssl
rm -rf Frameworks/libssl.framework
install -d Frameworks/libssl.framework/Headers
/usr/bin/lipo -create -output Frameworks/libssl.framework/libssl               \
  MK_DIST/ios/libressl/$LIBRESSL_VERSION/arm64/lib/libssl.a                    \
  MK_DIST/ios/libressl/$LIBRESSL_VERSION/armv7s/lib/libssl.a                   \
  MK_DIST/ios/libressl/$LIBRESSL_VERSION/x86_64/lib/libssl.a
touch Frameworks/libssl.framework/Headers/make_cocoapods_happy.h

# libevent
rm -rf Frameworks/libevent.framework
install -d Frameworks/libevent.framework/Headers
/usr/bin/lipo -create -output Frameworks/libevent.framework/libevent           \
  MK_DIST/ios/libevent/$LIBEVENT_VERSION/arm64/lib/libevent.a                  \
  MK_DIST/ios/libevent/$LIBEVENT_VERSION/armv7s/lib/libevent.a                 \
  MK_DIST/ios/libevent/$LIBEVENT_VERSION/x86_64/lib/libevent.a
touch Frameworks/libevent.framework/Headers/make_cocoapods_happy.h

# libevent_pthreads
rm -rf Frameworks/libevent_pthreads.framework
install -d Frameworks/libevent_pthreads.framework/Headers
/usr/bin/lipo -create -output                                                  \
    Frameworks/libevent_pthreads.framework/libevent_pthreads                   \
  MK_DIST/ios/libevent/$LIBEVENT_VERSION/arm64/lib/libevent_pthreads.a         \
  MK_DIST/ios/libevent/$LIBEVENT_VERSION/armv7s/lib/libevent_pthreads.a        \
  MK_DIST/ios/libevent/$LIBEVENT_VERSION/x86_64/lib/libevent_pthreads.a
touch Frameworks/libevent_pthreads.framework/Headers/make_cocoapods_happy.h

# libevent_openssl
rm -rf Frameworks/libevent_openssl.framework
install -d Frameworks/libevent_openssl.framework/Headers
/usr/bin/lipo -create -output                                                  \
    Frameworks/libevent_openssl.framework/libevent_openssl                     \
  MK_DIST/ios/libevent/$LIBEVENT_VERSION/arm64/lib/libevent_openssl.a          \
  MK_DIST/ios/libevent/$LIBEVENT_VERSION/armv7s/lib/libevent_openssl.a         \
  MK_DIST/ios/libevent/$LIBEVENT_VERSION/x86_64/lib/libevent_openssl.a
touch Frameworks/libevent_openssl.framework/Headers/make_cocoapods_happy.h

# measurement_kit
#
# Note: using the x86_64 headers because headers are MI.
rm -rf Frameworks/measurement_kit.framework
install -d Frameworks/measurement_kit.framework # note: different from above
/usr/bin/lipo -create -output                                                  \
    Frameworks/measurement_kit.framework/measurement_kit                       \
  MK_DIST/ios/measurement-kit/$MK_VERSION/arm64/lib/libmeasurement_kit.a       \
  MK_DIST/ios/measurement-kit/$MK_VERSION/armv7s/lib/libmeasurement_kit.a      \
  MK_DIST/ios/measurement-kit/$MK_VERSION/x86_64/lib/libmeasurement_kit.a
cp -Rp MK_DIST/ios/measurement-kit/$MK_VERSION/x86_64/include/measurement_kit  \
  Frameworks/measurement_kit.framework/Headers
